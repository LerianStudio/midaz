name: "Go Integration & E2E"

on:
  pull_request:
    branches: [ develop, main ]
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  integration-e2e:
    if: ${{ false }}
    runs-on: firmino-lxc-runners
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: false

      - name: Ensure Docker is available
        run: |
          docker version
          docker compose version || true

      - name: Prepare env files
        run: make set-env

      - name: Start backend stack
        run: make up-backend

      - name: Wait for services
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..60}; do
            if curl -fsS http://localhost:3000/health >/dev/null && curl -fsS http://localhost:3001/health >/dev/null; then
              echo "Services are up"; break; fi; sleep 2; done

      - name: Run Go integration tests
        env:
          ONBOARDING_URL: http://localhost:3000
          TRANSACTION_URL: http://localhost:3001
        run: go test -v ./tests/integration

      - name: Run Go E2E tests
        env:
          ONBOARDING_URL: http://localhost:3000
          TRANSACTION_URL: http://localhost:3001
        run: go test -v ./tests/e2e

      - name: Teardown backend stack
        if: always()
        run: make down-backend

