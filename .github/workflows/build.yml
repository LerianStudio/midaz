name: "Build"

# This workflow builds and pushes Docker images
# Triggered on any tag push (e.g., v1.0.0, v1.0.0-beta.1)
#
# Monorepo strategy:
# - Uses filter_paths to detect which components changed
# - Builds only the changed components
# - Updates GitOps for beta/rc tags

on:
  push:
    tags:
      - '**'

jobs:
  build:
    uses: LerianStudio/github-actions-shared-workflows/.github/workflows/build.yml@feature/go-workflows
    with:
      # Monorepo configuration
      filter_paths: |-
        components/onboarding
        components/transaction
        components/console
      path_level: 2
      app_name_prefix: "midaz"
      # Registry configuration
      enable_dockerhub: true
      enable_ghcr: true
      dockerhub_org: lerianstudio
      # GitOps artifacts for update_gitops job
      enable_gitops_artifacts: true
    secrets: inherit

  # =========================
  # GITOPS UPDATE
  # =========================
  update_gitops:
    needs: [build]
    if: (contains(github.ref, '-beta') || contains(github.ref, '-rc')) && needs.build.result == 'success'
    uses: LerianStudio/github-actions-shared-workflows/.github/workflows/gitops-update.yml@feature/go-workflows
    with:
      gitops_repository: "LerianStudio/midaz-firmino-gitops"
      gitops_server: "firmino"
      app_name: "midaz"
      artifact_pattern: "gitops-tags-midaz-*"
      yaml_key_mappings: '{"onboarding.tag": ".onboarding.image.tag", "transaction.tag": ".transaction.image.tag", "console.tag": ".console.image.tag"}'
      commit_message_prefix: "midaz"
      enable_argocd_sync: true
      argocd_app_name: "firmino-midaz"
      use_dynamic_mapping: true
    secrets: inherit

  # =========================
  # E2E TESTS
  # =========================
  api-dog-e2e-tests:
    needs: update_gitops
    if: (contains(github.ref, '-beta') || contains(github.ref, '-rc')) && needs.update_gitops.result == 'success'
    uses: LerianStudio/github-actions-shared-workflows/.github/workflows/api-dog-e2e-tests.yml@feature/go-workflows
    with:
      auto_detect_environment: true
    secrets:
      test_scenario_id: ${{ secrets.MIDAZ_APIDOG_TEST_SCENARIO_ID }}
      apidog_access_token: ${{ secrets.APIDOG_ACCESS_TOKEN }}
      dev_environment_id: ${{ secrets.MIDAZ_APIDOG_DEV_ENVIRONMENT_ID }}
      stg_environment_id: ${{ secrets.MIDAZ_APIDOG_STG_ENVIRONMENT_ID }}