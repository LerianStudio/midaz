name: "Midaz E2E Tests"

on:
  push:
    branches:
      - chore/newman_e2e_tests
    tags-ignore:
      - "**"

jobs:
  midaz-e2e-tests:
    name: Run Midaz E2E Tests
    runs-on: firmino-gh-actions-runners
    steps:
      - uses: actions/checkout@v4

      - name: Generate Swagger and update Postman collection
        run: |
          cd midaz
          export PATH=$PATH:/usr/local/go/bin:$(go env GOPATH)/bin
          go install github.com/swaggo/swag/cmd/swag@latest
          swag --version
          make tidy
          make generate-docs
          cd ..

      - uses: actions/setup-node@v2
        with:
          node-version: "23"

      - name: "Install newman"
        run: "npm install -g newman"

      - name: "Update URLs in Postman environment"
        run: |
          sed -i 's#\"value\": \"{{baseUrl}}:{{onboardingPort}}\"#\"value\": \"https://onboarding.lerian.net\"#' postman/MIDAZ.postman_environment.json
          sed -i 's#\"value\": \"{{baseUrl}}:{{transactionPort}}\"#\"value\": \"https://transaction.lerian.net\"#' postman/MIDAZ.postman_environment.json

      - name: "Run tests"
        run: "newman run postman/MIDAZ.postman_collection.json -e postman/MIDAZ.postman_environment.json"