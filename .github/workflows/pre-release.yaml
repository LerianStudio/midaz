name: "Pre-Release GitOps Update"

on:
  workflow_run:
    workflows: ["Build midaz images"]
    types:
      - completed

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  update_gitops:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Update GitOps values.yaml
    runs-on: ubuntu-latest

    steps:
      # Checkout the source repo to detect changed components and tags
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          path: source
          fetch-depth: 0

      # Detect changed components
      - name: Detect changed components
        id: detect
        uses: LerianStudio/github-actions-changed-paths@main
        with:
          filter_paths: |
            components/onboarding
            components/transaction
            components/console
          get_app_name: true
          path_level: 2
          app_name_prefix: midaz

      # Import GPG key for signing commits
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.LERIAN_CI_CD_USER_GPG_KEY }}
          passphrase: ${{ secrets.LERIAN_CI_CD_USER_GPG_KEY_PASSWORD }}
          git_committer_name: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          git_committer_email: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true

      # Checkout the GitOps repository
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: LerianStudio/midaz-firmino-gitops
          ref: main
          token: ${{ secrets.MANAGE_TOKEN }}
          fetch-depth: 0
          path: gitops

      # Extract individual tags for each changed component and update values.yaml
      - name: Update values.yaml with correct image tags
        run: |
          cd source
          COMPONENTS=$(echo '${{ steps.detect.outputs.matrix }}' | jq -r '.[].name')

          for COMPONENT in $COMPONENTS; do
            echo "üîç Checking latest tag for component: $COMPONENT"
            LAST_COMMIT=$(git log -1 --format="%H" -- components/${COMPONENT#midaz-})
            TAG=$(git tag --contains "$LAST_COMMIT" | grep '^v' | sort -V | tail -n1)

            if [ -z "$TAG" ]; then
              echo "‚ùå No tag found for $COMPONENT, skipping..."
              continue
            fi

            echo "‚úÖ Found tag $TAG for $COMPONENT"

            # Update the tag in the GitOps values.yaml
            yq e ".$COMPONENT.image.tag = \"${TAG#v}\"" -i ../gitops/environments/firmino/helmfile/midaz/values.yaml
          done

      # Commit and push changes
      - name: Commit and push updated values.yaml
        env:
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          GIT_AUTHOR_NAME: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          GIT_AUTHOR_EMAIL: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
          GIT_COMMITTER_NAME: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          GIT_COMMITTER_EMAIL: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
        run: |
          cd gitops
          git add environments/firmino/helmfile/midaz/values.yaml
          git commit -S -m "ci: update image tags based on latest component releases"
          git push origin main