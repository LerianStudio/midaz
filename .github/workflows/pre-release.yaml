name: "Pre-Release GitOps Update"

on:
  repository_dispatch:
    types: [trigger-gitops-update]

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  update_gitops:
    name: Update GitOps values.yaml
    runs-on: ubuntu-latest

    steps:
      # Checkout source repository to detect changed components
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          path: source
          fetch-depth: 0

      # Detect which components changed
      - name: Detect changed components
        id: detect
        uses: LerianStudio/github-actions-changed-paths@main
        with:
          filter_paths: |
            components/onboarding
            components/transaction
            components/console
          get_app_name: true
          path_level: 2
          app_name_prefix: midaz

      # Import GPG key for signed commit
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.LERIAN_CI_CD_USER_GPG_KEY }}
          passphrase: ${{ secrets.LERIAN_CI_CD_USER_GPG_KEY_PASSWORD }}
          git_committer_name: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          git_committer_email: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true

      # Checkout GitOps repository
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: LerianStudio/midaz-firmino-gitops
          ref: main
          token: ${{ secrets.MANAGE_TOKEN }}
          fetch-depth: 0
          path: gitops

      - name: Get latest tag
        id: tag
        run: |
          cd source
          git fetch --tags
          echo "tag=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      # Update values.yaml with the correct image tag
      - name: Update image tags for changed components
        run: |
          components=$(echo '${{ steps.detect.outputs.matrix }}' | jq -r '.[].name')
          for component in $components; do
            echo "ðŸ”„ Updating tag for $component to ${{ steps.tag.outputs.tag }}"
            yq e ".$component.image.tag = \"${{ steps.tag.outputs.tag }}\"" -i gitops/environments/firmino/helmfile/midaz/values.yaml
          done

      # Commit and push changes to GitOps repo
      - name: Commit and push changes to GitOps
        env:
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          GIT_AUTHOR_NAME: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          GIT_AUTHOR_EMAIL: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
          GIT_COMMITTER_NAME: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          GIT_COMMITTER_EMAIL: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
        run: |
          cd gitops
          git add environments/firmino/helmfile/midaz/values.yaml
          git commit -S -m "ci: update image tags to ${{ steps.tag.outputs.tag }}"
          git push origin main