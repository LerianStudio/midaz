name: "Pre-Release GitOps Update"

on:
  push:
    tags:
      - 'v*.*.*-beta.*'

permissions:
  id-token: write       # Needed for authentication
  contents: write       # Needed to create releases and tags
  pull-requests: write  # Needed to create/update PRs

jobs:
  detect_changes:
    name: Detect changed components
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.changed.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      # Detect which components have changed based on paths
      - name: Detect changed paths
        id: changed
        uses: LerianStudio/github-actions-changed-paths@main
        with:
          filter_paths: |
            components/onboarding
            components/transaction
            components/console
          get_app_name: true
          path_level: 2
          app_name_prefix: midaz

  update_gitops:
    name: Update GitOps with pre-release tag
    needs: detect_changes
    if: needs.detect_changes.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect_changes.outputs.matrix) }}
    steps:
      # Create a token for the GitHub App that will commit to the GitOps repo
      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.LERIAN_STUDIO_MIDAZ_PUSH_BOT_APP_ID }}
          private-key: ${{ secrets.LERIAN_STUDIO_MIDAZ_PUSH_BOT_PRIVATE_KEY }}

      # Checkout the GitOps repo using the GitHub App token
      - uses: actions/checkout@v4
        with:
          repository: LerianStudio/midaz-firmino-gitops
          ref: main
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      # Extract the tag name from the Git reference (e.g., v2.3.0-beta.1)
      - name: Extract tag
        id: extract
        run: echo "tag=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # Update the appropriate image tag in the Helmfile values.yaml
      - name: Update tag in values.yaml
        run: |
          yq e '.${{ matrix.app.name }}.image.tag = "${{ steps.extract.outputs.tag }}"' -i environments/firmino/helmfile/midaz/values.yaml

      # Import the GPG key to sign the commit
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.LERIAN_CI_CD_USER_GPG_KEY }}
          passphrase: ${{ secrets.LERIAN_CI_CD_USER_GPG_KEY_PASSWORD }}
          git_committer_name: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          git_committer_email: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
          git_config_global: true
          git_user_signingkey: true
          git_commit_gpgsign: true

      # Commit the updated values.yaml with a signed commit using the GitHub App identity
      - name: Commit and push
        env:
          GIT_AUTHOR_NAME: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          GIT_AUTHOR_EMAIL: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
          GIT_COMMITTER_NAME: ${{ secrets.LERIAN_CI_CD_USER_NAME }}
          GIT_COMMITTER_EMAIL: ${{ secrets.LERIAN_CI_CD_USER_EMAIL }}
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add environments/firmino/helmfile/midaz/values.yaml
          git commit -S -m "ci: update ${{ matrix.app.name }} tag to ${{ steps.extract.outputs.tag }}"
          git push