#!/bin/bash

REPO_ROOT=$(git rev-parse --show-toplevel)
source "$REPO_ROOT"/pkg/shell/colors.sh
source "$REPO_ROOT"/pkg/shell/ascii.sh

# Check if trying to commit to protected branches
branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$branch" == "main" || "$branch" == "develop" || "$branch" == "release-candidate" ]]; then
    echo "${red}❌ You can't commit directly to protected branches${reset}"
    exit 1
fi

# Block .env files from being committed (security)
ENV_FILES=$(git diff --cached --name-only | grep -E '\.env$|\.env\.local$|\.env\.[^.]+\.local$' || true)
if [ -n "$ENV_FILES" ]; then
    echo "${red}❌ Attempting to commit .env file(s):${reset}"
    echo "$ENV_FILES"
    echo ""
    echo "Remove from staging: ${bold}git reset HEAD <file>${reset}"
    exit 1
fi

# Block large files (>5MB) from being committed
LARGE_FILES=""
while IFS= read -r file; do
    if [ -n "$file" ] && [ -f "$file" ]; then
        size=$(wc -c < "$file" | tr -d ' ')
        if [ "$size" -gt 5242880 ]; then
            size_human=$(awk "BEGIN {printf \"%.1f MB\", $size/1048576}")
            LARGE_FILES="${LARGE_FILES}${file} (${size_human})\n"
        fi
    fi
done < <(git diff --cached --name-only --diff-filter=d)

if [ -n "$LARGE_FILES" ]; then
    echo "${red}❌ Attempting to commit large files (>5MB):${reset}"
    echo -e "$LARGE_FILES"
    echo "Remove from staging or use Git LFS"
    exit 1
fi

# Scan for secrets in staged files (gitleaks)
if ! command -v gitleaks &> /dev/null; then
    echo "${red}❌ gitleaks not installed${reset}"
    echo "Install with: brew install gitleaks"
    echo "         or: go install github.com/zricethezav/gitleaks/v8@latest"
    exit 1
fi
echo "Scanning for secrets..."
if ! gitleaks protect --staged --no-banner 2>/dev/null; then
    echo "${red}❌ Secrets detected in staged files!${reset}"
    echo ""
    echo "Review the findings above and remove secrets before committing."
    echo "If this is a false positive, add to .gitleaksignore"
    exit 1
fi
echo "${green}✅ No secrets detected${reset}"