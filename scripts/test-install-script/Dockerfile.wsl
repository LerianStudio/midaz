FROM ubuntu:22.04

# Install basic dependencies including Windows interoperability packages
RUN apt-get update && apt-get install -y \
    curl \
    git \
    make \
    sudo \
    wslu \
    ca-certificates \
    apt-transport-https \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user for testing
RUN useradd -m testuser && echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser

# Set working directory
WORKDIR /home/testuser

# Copy the install script
COPY --chown=testuser:testuser install.sh /home/testuser/install.sh
RUN chmod +x /home/testuser/install.sh

# Switch to testuser
USER testuser

# Set environment variables for non-interactive installation
ENV MIDAZ_DIR=/home/testuser/midaz
ENV MIDAZ_REF=main
ENV INSTALL_FLAGS=-y
ENV MIDAZ_DEMO_DATA=minimal
# Simulate WSL environment
ENV WSL_DISTRO_NAME=Ubuntu-22.04
ENV WSL_INTEROP=/run/WSL/8_interop

# Command to run the install script
CMD ["./install.sh", "--yes"]
