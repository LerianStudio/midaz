FROM alpine:3.16

# Install basic dependencies
RUN apk add --no-cache \
    curl \
    git \
    make \
    sudo \
    bash

# Create a non-root user for testing
RUN adduser -D testuser && echo "testuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/testuser

# Set working directory
WORKDIR /home/testuser

# Copy the install script
COPY --chown=testuser:testuser ../install.sh /home/testuser/install.sh
RUN chmod +x /home/testuser/install.sh

# Switch to testuser
USER testuser

# Set environment variables for non-interactive installation
ENV MIDAZ_DIR=/home/testuser/midaz
ENV MIDAZ_REF=main
ENV INSTALL_FLAGS=-y

# Command to run the install script
CMD ["./install.sh", "--yes"]
