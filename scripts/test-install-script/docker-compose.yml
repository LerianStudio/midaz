version: '3.8'

services:
  ubuntu:
    build:
      context: ..
      dockerfile: ./test-install-script/Dockerfile.ubuntu
    volumes:
      - ./logs:/home/testuser/logs
    environment:
      - TEST_DISTRO=ubuntu
      - MIDAZ_DEMO_DATA=minimal
    command: >
      bash -c "
        mkdir -p /home/testuser/logs &&
        (./install.sh --yes > /home/testuser/logs/ubuntu.log 2>&1 || echo 'FAILED' > /home/testuser/logs/ubuntu.status) &&
        if [ ! -f /home/testuser/logs/ubuntu.status ]; then echo 'SUCCESS' > /home/testuser/logs/ubuntu.status; fi
      "

  debian:
    build:
      context: ..
      dockerfile: ./test-install-script/Dockerfile.debian
    volumes:
      - ./logs:/home/testuser/logs
    environment:
      - TEST_DISTRO=debian
      - MIDAZ_DEMO_DATA=minimal
    command: >
      bash -c "
        mkdir -p /home/testuser/logs &&
        (./install.sh --yes > /home/testuser/logs/debian.log 2>&1 || echo 'FAILED' > /home/testuser/logs/debian.status) &&
        if [ ! -f /home/testuser/logs/debian.status ]; then echo 'SUCCESS' > /home/testuser/logs/debian.status; fi
      "

  fedora:
    build:
      context: ..
      dockerfile: ./test-install-script/Dockerfile.fedora
    volumes:
      - ./logs:/home/testuser/logs
    environment:
      - TEST_DISTRO=fedora
      - MIDAZ_DEMO_DATA=minimal
    command: >
      bash -c "
        mkdir -p /home/testuser/logs &&
        (./install.sh --yes > /home/testuser/logs/fedora.log 2>&1 || echo 'FAILED' > /home/testuser/logs/fedora.status) &&
        if [ ! -f /home/testuser/logs/fedora.status ]; then echo 'SUCCESS' > /home/testuser/logs/fedora.status; fi
      "

  alpine:
    build:
      context: ..
      dockerfile: ./test-install-script/Dockerfile.alpine
    volumes:
      - ./logs:/home/testuser/logs
    environment:
      - TEST_DISTRO=alpine
      - MIDAZ_DEMO_DATA=minimal
    command: >
      bash -c "
        mkdir -p /home/testuser/logs &&
        (./install.sh --yes > /home/testuser/logs/alpine.log 2>&1 || echo 'FAILED' > /home/testuser/logs/alpine.status) &&
        if [ ! -f /home/testuser/logs/alpine.status ]; then echo 'SUCCESS' > /home/testuser/logs/alpine.status; fi
      "

  wsl:
    build:
      context: ..
      dockerfile: ./test-install-script/Dockerfile.wsl
    volumes:
      - ./logs:/home/testuser/logs
    environment:
      - TEST_DISTRO=wsl-ubuntu
      - MIDAZ_DEMO_DATA=minimal
    command: >
      bash -c "
        mkdir -p /home/testuser/logs &&
        (./install.sh --yes > /home/testuser/logs/wsl.log 2>&1 || echo 'FAILED' > /home/testuser/logs/wsl.status) &&
        if [ ! -f /home/testuser/logs/wsl.status ]; then echo 'SUCCESS' > /home/testuser/logs/wsl.status; fi
      "

  arm:
    build:
      context: ..
      dockerfile: ./test-install-script/Dockerfile.arm
    platform: linux/arm64
    volumes:
      - ./logs:/home/testuser/logs
    environment:
      - TEST_DISTRO=arm-ubuntu
      - MIDAZ_DEMO_DATA=minimal
    command: >
      bash -c "
        mkdir -p /home/testuser/logs &&
        (./install.sh --yes > /home/testuser/logs/arm.log 2>&1 || echo 'FAILED' > /home/testuser/logs/arm.status) &&
        if [ ! -f /home/testuser/logs/arm.status ]; then echo 'SUCCESS' > /home/testuser/logs/arm.status; fi
      "
